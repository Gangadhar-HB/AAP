#cloud-config

#
# Basic System Initialization
#
ntp:
  enabled: true
  ntp_client: ntp

timezone: {{ timezone }}
ssh_pwauth: True

#
# File Creation
#
write_files:

  # Flag file for partitioning script
  - path: /root/install.cfg
    permissions: '0644'
    owner: root:root
    content: |
      install=true

  # Thin pool volume configuration
  - path: "/root/{{ item.vm_type }}_thin_pool_volume.cfg"
    permissions: '0644'
    owner: root:root
    content: |
      {{ user_data_action | indent(6) }}

  # One-shot systemd partitioning service
  - path: /etc/systemd/system/partition.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=One-time disk partitioning service
      After=cloud-final.service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/vm_config_thin_vol.sh -d 2 --device sdb create "/root/{{ item.vm_type }}_thin_pool_volume.cfg" "/root/install.cfg"
      ExecStartPost=/bin/systemctl disable partition.service

      [Install]
      WantedBy=multi-user.target

  # Network interfaces
{% for iface in vm_info.networkInterface %}
  - path: "/etc/sysconfig/network-scripts/ifcfg-eth{{ loop.index0 }}"
    permissions: '0644'
    owner: root:root
    content: |
      DEVICE=eth{{ loop.index0 }}
      ONBOOT=yes
      BOOTPROTO=static
      IPADDR={{ iface.ipaddress.split('/')[0] }}
      PREFIX={{ iface.ipaddress.split('/')[1] }}
      {% if iface.gw is defined %}
      GATEWAY={{ iface.gw }}
      {% endif %}
      DNS1={{ dns_servers[0] | default('8.8.8.8') }}
      DNS2={{ dns_servers[1] | default('8.8.4.4') }}
      NM_CONTROLLED=yes
{% endfor %}

  # Create route script
  - path: /usr/local/bin/route_add.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      LOGFILE="/var/log/route_add.log"

      {% if routes %}
      {% for rt in routes %}
      {% if effective_setup == "0" %}
      MACV_NAME=$(echo {{ rt }} | sed 's/dpbr_/macv/')
      echo "Creating route file for $MACV_NAME" | tee -a "$LOGFILE"
      echo "$MACV_NAME" >> /etc/sysconfig/network-scripts/route-$MACV_NAME
      {% else %}
      echo "Creating route file for eth0" | tee -a "$LOGFILE"
      echo "{{ rt | regex_replace('dpbr_([0-9]+)','eth0') }}" >> /etc/sysconfig/network-scripts/route-eth0
      {% endif %}
      {% endfor %}
      {% else %}
      echo "No routes defined" | tee -a "$LOGFILE"
      {% endif %}

#
# Command Execution
#
runcmd:
  # Enable and run the partition service
  - systemctl enable partition.service --now

  # Add static routes
  - sh /usr/local/bin/route_add.sh

  # Disable cloud-init for future boots
  - touch /etc/cloud/cloud-init.disabled

