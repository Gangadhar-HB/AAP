---
- hosts: all
  gather_facts: no
  vars:
    successful_vms_file: "/tmp/successful_vms.json"
    inventory_file: "/tmp/dynamic_inventory.ini"
  tasks:

    - name: Load successful VMs JSON
      slurp:
        src: "{{ successful_vms_file }}"
      register: vms_json

    - name: Set successful_vms fact
      set_fact:
        successful_vms: "{{ vms_json.content | b64decode | from_json }}"

    - name: Prepare BM list and mapping of VMs
      set_fact:
        bms: "{{ bms | default([]) | union([item.bm | default('unknown_bm')]) }}"
        bms_vms: >-
          {{
            bms_vms | default({}) | combine({
              (item.bm | default('unknown_bm')):
              (bms_vms[item.bm | default('unknown_bm')] | default([])) + [item.ip_address]
            })
          }}
      loop: "{{ successful_vms }}"

    - name: Initialize inventory content
      set_fact:
        inventory_content: "[BM]\n{{ bms | join('\n') }}\n\n"

    - name: Add VM groups per BM
      set_fact:
        inventory_content: "{{ inventory_content + '[VM_' + item.key + ']\n' + item.value | join('\n') + '\n\n' }}"
      loop: "{{ bms_vms | dict2items }}"

    - name: Save dynamic inventory file
      copy:
        content: "{{ inventory_content }}"
        dest: "{{ inventory_file }}"

    - name: Show generated inventory
      debug:
        msg: "{{ inventory_content }}"

