---
# Playbook: post_vm_configure.yml
# Purpose: Wait for SSH and run post-configuration on successfully launched VMs

- hosts: localhost
  gather_facts: no
  vars:
    failed_vms: []
  tasks:

    - name: "Build dynamic inventory for successful VMs"
      ansible.builtin.add_host:
        name: "{{ item.hostip }}"
        groups: new_vms
      loop: "{{ successful_vms }}"
      loop_control:
        loop_var: item

- hosts: new_vms
  gather_facts: yes
  tasks:

    - name: "Wait for SSH to be available on new VMs"
      ansible.builtin.wait_for_connection:
        delay: 20
        timeout: 300

    - name: "Run Post VM Configuration tasks"
      ansible.builtin.include_tasks: files/PostVMLaunch.yml

- hosts: localhost
  gather_facts: no
  tasks:
    - name: "Fail if any VMs failed to configure"
      ansible.builtin.fail:
        msg: "The following VMs failed to launch or configure: {{ failed_vms | default([]) }}"
      run_once: true
      when: failed_vms | length > 0

