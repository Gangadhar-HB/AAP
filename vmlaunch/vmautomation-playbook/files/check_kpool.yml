---

- name: Setting fact for vm hostname
  ansible.builtin.set_fact:
    ansible_host: "{{ BMIP }}"

# ----------------------------------------------
# Gather only LVM facts
# ----------------------------------------------
- name: Gather LVM information
  ansible.builtin.setup:
    gather_subset:
      - '!all'
      - '!min'
      - hardware
    filter: ansible_lvm
# ----------------------------------------------
# Determine whether kpool exists
# ----------------------------------------------
- name: Check if thin pool kpool already exists
  ansible.builtin.set_fact:
    has_kpool: "{{ 'kpool' in ansible_lvm.lvs }}"
# ----------------------------------------------
# If thin pool exists — get its size
# ----------------------------------------------
- name: Extract existing thin pool size (MB)
  ansible.builtin.set_fact:
    thinPoolsize: "{{ (ansible_lvm.lvs['kpool'].size_g | float * 1024) | int }}"
  when: has_kpool
# ----------------------------------------------
# If thinpool does not exist — calculate free space
# ----------------------------------------------
- name: Extract VG free space (MB)
  ansible.builtin.set_fact:
    freespace_mb: "{{ ansible_lvm.vgs[vg_name].free_g | float * 1024 }}"
  when: not has_kpool
# ----------------------------------------------
# Calculate new thinpool size = % of free space
# ----------------------------------------------
- name: Calculate new thin pool size (MB)
  ansible.builtin.set_fact:
    new_thinpoolsize: >-
      {{ (ansible_lvm.vgs[vg_name].free_g | float * 1024 * thinpool_BM / 100) | int }}
  when: not has_kpool
# ----------------------------------------------
# Create thin pool using module
# ----------------------------------------------
- name: Create thin pool LV
  community.general.lvol:
    vg: "{{ vg_name }}"
    lv: kpool
    size: "{{ new_thinpoolsize }}m"
    opts: --type thin-pool
  when: not has_kpool and new_thinpoolsize|int < freespace_mb|int
# ----------------------------------------------
# Fail gracefully if no free space
# ----------------------------------------------
- name: Fail if free space is insufficient
  ansible.builtin.fail:
    msg: "Not enough space to create thin pool kpool in VG {{ vg_name }}"
  when: not has_kpool and new_thinpoolsize|int >= freespace_mb|int
# ----------------------------------------------
# Final fact output for downstream plays
# ----------------------------------------------
- name: Set final thin pool size fact
  ansible.builtin.set_fact:
    thinPoolsize: "{{ thinPoolsize | default(new_thinpoolsize) }}"