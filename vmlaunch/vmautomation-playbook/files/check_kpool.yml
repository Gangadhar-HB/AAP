---

# ------------------------------------------------------------
# Check if thin pool "kpool" exists
# ------------------------------------------------------------
- name: Get LVM volumes with devices column
  ansible.builtin.command:
    cmd: lvs -a -o lv_name,lv_size,devices --units g --nosuffix
  register: lvs_output

- name: Extract kpool LV line
  ansible.builtin.set_fact:
    kpool_line: "{{ lvs_output.stdout_lines | select('search', '^kpool ') | list | first | default('') }}"

- name: Determine if kpool exists
  ansible.builtin.set_fact:
    hasKpool: "{{ kpool_line != '' }}"

# ------------------------------------------------------------
# Existing thin pool - extract size
# ------------------------------------------------------------
- block:

    - name: Extract thin pool size (numeric)
      ansible.builtin.set_fact:
        thinPoolsize: "{{ (kpool_line.split()[1] | float) * 1024 | int }}"
        # lvs output has size in GB, convert to MB

  when: hasKpool

# ------------------------------------------------------------
# Thin pool NOT present - compute new size & create
# ------------------------------------------------------------
- block:

    - name: Get VG details
      ansible.builtin.command:
        cmd: vgdisplay -c {{ vg_name | default('vg01') }}
      register: vginfo

    - name: Extract free space in MB
      ansible.builtin.set_fact:
        freespace_mb: >-
          {{
            (
              (vginfo.stdout.split(':')[15] | int)   # free PE count
              * 4096 / 1024 / 1024                   # convert PE â†’ MB
            ) | int
          }}

    - name: Calculate desired thinpool size (default 80%)
      ansible.builtin.set_fact:
        new_thinpoolsize_mb: >-
          {{
            (
              freespace_mb * (thinpool_BM | default(80) | int) / 100
            ) | int
          }}

    - name: Create thin pool if space available
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/manage_kodiak_thin_pool.sh
          -s {{ new_thinpoolsize_mb }}
          -v {{ vg_name | default('vg01') }}
          POOL kpool
      when: new_thinpoolsize_mb < freespace_mb
      become: true

    - name: Register new thin pool size
      ansible.builtin.set_fact:
        thinPoolsize: "{{ new_thinpoolsize_mb }}"

  when: not hasKpool
