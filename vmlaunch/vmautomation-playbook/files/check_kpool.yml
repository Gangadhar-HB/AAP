---
# ---------------------------------------------------------------
# 1. Get LV information and check if kpool exists
# ---------------------------------------------------------------
- name: Get LV info
  community.general.lvm_lv_info:
    vg: "{{ vg_name }}"
  register: lvinfo

- name: Determine if kpool exists
  set_fact:
    hasKpool: "{{ 'kpool' in (lvinfo.lvs | map(attribute='lv_name') | list) }}"
    
# ---------------------------------------------------------------
# 2. When kpool exists → calculate its size
# ---------------------------------------------------------------
- block:
    - name: Extract kpool LV info
      set_fact:
        kpool: "{{ lvinfo.lvs | selectattr('lv_name','equalto','kpool') | first }}"
    - name: Calculate thin pool size (convert major+minor units to GB)
      set_fact:
        thinPoolsize: "{{ (kpool.lv_size|float) | int }}"
  when: hasKpool
# ---------------------------------------------------------------
# 3. When kpool NOT exists → create new thin pool
# ---------------------------------------------------------------
- block:
    # ---- Get VG details (free space etc.) ----
    - name: Get VG info
      community.general.lvm_vg_info:
        vg: "{{ vg_name }}"
      register: vginfo
    - name: Calculate free space (GB)
      set_fact:
        freespace: "{{ (vginfo.vgs[0].free | float) | int }}"
    - name: Calculate 80% of free space
      set_fact:
        new_thinpoolsize: "{{ ((freespace * thinpool_percent / 100) | int) }}"
    - name: Fail when thinpool > free space
      fail:
        msg: "Thinpool size {{ new_thinpoolsize }} GB cannot exceed free space {{ freespace }} GB."
      when: new_thinpoolsize|int > freespace|int
    - name: Create thin pool
      community.general.lvm_lv:
        vg: "{{ vg_name }}"
        lv: "kpool"
        size: "{{ new_thinpoolsize }}g"
        thinpool: true
      become: true
    - name: Set thinPoolsize fact
      set_fact:
        thinPoolsize: "{{ new_thinpoolsize }}"
  when: not hasKpool
