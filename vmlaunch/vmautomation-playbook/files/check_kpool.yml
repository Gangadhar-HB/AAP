---

- name: Set fact for vm hostname
  ansible.builtin.set_fact:
    ansible_host: "{{ BMIP }}"

- name: Get existing thin pools
  ansible.builtin.command:
    cmd: lvs -a -o lv_name
  register: lv_names
- name: Check if kpool exists
  ansible.builtin.set_fact:
    hasKpool: "{{ 'kpool' in lv_names.stdout_lines }}"

- block:
    - name: Get detailed lvs output for kpool
      ansible.builtin.command:
        cmd: lvs -a -o lv_name,lv_size --units g --nosuffix
      register: kpool_info
    - name: Extract kpool size (GB)
      ansible.builtin.set_fact:
        kpool_size_gb: "{{ item.split()[1] | float }}"
      loop: "{{ kpool_info.stdout_lines }}"
      when: item.startswith('kpool ')
      loop_control:
        loop_var: item
    - name: Set thinPoolsize from existing kpool
      ansible.builtin.set_fact:
        thinPoolsize: "{{ (kpool_size_gb * 1024) | int }}"   # convert GB â†’ MB
  when: hasKpool

- block:
    - name: Read VG details using `vgdisplay`
      ansible.builtin.command:
        cmd: vgdisplay -c {{ vg_name | default('vg01') }}
      register: vg_raw
    - name: Parse free PE from vgdisplay output
      ansible.builtin.set_fact:
        vg_fields: "{{ vg_raw.stdout.split(':') }}"
    - name: Set free space (MB)
      ansible.builtin.set_fact:
        freespace_mb: "{{ (vg_fields[15] | int) * 4 }}"
    - name: Compute 80% of free space
      ansible.builtin.set_fact:
        new_thinpoolsize_mb: "{{ (freespace_mb * (thinpool_BM | default(80)) / 100) | int }}"
    - name: Create thin pool if enough free space
      community.general.lvol:
        vg: "{{ vg_name | default('vg01') }}"
        lv: kpool
        size: "{{ new_thinpoolsize_mb }}M"
        opts: "--thinpool"
      when: new_thinpoolsize_mb < freespace_mb
    - name: Set thinPoolsize from new pool
      ansible.builtin.set_fact:
        thinPoolsize: "{{ new_thinpoolsize_mb }}"
  when: not hasKpool

