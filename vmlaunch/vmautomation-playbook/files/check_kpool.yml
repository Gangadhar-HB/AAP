---
# ----------------------------------------------------------
# 1. Read LV details as JSON (SUPPORTED)
# ----------------------------------------------------------
- name: Read LV details using LVM JSON
  command: "lvs --reportformat json"
  register: lvjson
- name: Parse LV JSON
  set_fact:
    lvdata: "{{ lvjson.stdout | from_json }}"
- debug:
    var: lvdata
    
- name: Check if thin pool 'kpool' exists
  set_fact:
    kpool_info: "{{ lvdata.report[0].lv | selectattr('lv_name','equalto','kpool') | list }}"
    hasKpool: "{{ kpool_info | length > 0 }}"
# ----------------------------------------------------------
# 2. Existing thin pool â†’ read size
# ----------------------------------------------------------
- block:
    - name: Set existing thin pool size
      set_fact:
        thinPoolsize: "{{ (kpool_info[0].lv_size | float) | int }}"
  when: hasKpool
# ----------------------------------------------------------
# 3. Create a new thin pool if it does NOT exist
# ----------------------------------------------------------
- block:
    # --- Read VG info ---
    - name: Read VG info in colon format
      command: "vgdisplay --colon {{ vg_name }}"
      register: vgdata
    - name: Extract free space from VG
      set_fact:
        freePE: "{{ vgdata.stdout.split(':')[15] | int }}"
        peSize: "{{ vgdata.stdout.split(':')[12] | int }}"
        freespace: "{{ (freePE * peSize) / 1024 / 1024 }}"
    - name: Calculate new thin pool size (80% free)
      set_fact:
        new_thinpoolsize: "{{ (freespace * thinpool_percent / 100) | int }}"
    - name: Check if enough free space exists
      fail:
        msg: "Not enough free space: need {{ new_thinpoolsize }} GB but have {{ freespace }} GB"
      when: new_thinpoolsize | int > freespace | int
    - name: Create new thin pool using supported module
      community.general.lvol:
        vg: "{{ vg_name }}"
        lv: "kpool"
        size: "{{ new_thinpoolsize }}g"
        thinpool: true
      become: true
    - name: Register created thin pool size
      set_fact:
        thinPoolsize: "{{ new_thinpoolsize }}"
  when: not hasKpool