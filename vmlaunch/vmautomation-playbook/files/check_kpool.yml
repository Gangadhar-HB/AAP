---

#############################################################
#  CHECK IF THIN POOL EXISTS
#############################################################

- name: Get LVM volumes (safe, no grep/awk)
  ansible.builtin.command:
    cmd: lvs -a -o lv_name,lv_size,devices --units g --nosuffix
  register: lvs_output
  become: true

- name: Extract kpool LV line
  ansible.builtin.set_fact:
    kpool_line: "{{ lvs_output.stdout_lines
                    | select('search', '^kpool\\b')
                    | list
                    | first
                    | default('') }}"

- name: Determine if kpool exists
  ansible.builtin.set_fact:
    hasKpool: "{{ kpool_line != '' }}"

#############################################################
#  EXISTING THIN POOL — GET SIZE
#############################################################
- block:

    - name: Extract thin pool size in MB
      ansible.builtin.set_fact:
        thinPoolsize: "{{ (kpool_line.split()[1] | float * 1024) | int }}"
        # lvs output gives size in GB; converting to MB

  when: hasKpool

#############################################################
#  THIN POOL MISSING — CREATE NEW THIN POOL
#############################################################
- block:

    - name: Get VG details
      ansible.builtin.command:
        cmd: vgdisplay -c {{ vg_name | default('vg01') }}
      register: vginfo
      become: true

    - name: Extract free PEs from field 16
      ansible.builtin.set_fact:
        free_pe: "{{ vginfo.stdout.split(':')[15] | int }}"

    - name: Convert PE → MB
      ansible.builtin.set_fact:
        freespace_mb: "{{ (free_pe * 4096 / 1024 / 1024) | int }}"

    - name: Calculate thin pool size (default 80%)
      ansible.builtin.set_fact:
        new_thinpoolsize_mb: "{{ (freespace_mb * (thinpool_BM | default(80) | int) / 100) | int }}"

    - name: Create thin pool
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/manage_kodiak_thin_pool.sh
          -s {{ new_thinpoolsize_mb }}
          -v {{ vg_name | default('vg01') }}
          POOL kpool
      when: new_thinpoolsize_mb < freespace_mb
      become: true

    - name: Set final thinPoolsize fact
      ansible.builtin.set_fact:
        thinPoolsize: "{{ new_thinpoolsize_mb }}"

  when: not hasKpool
