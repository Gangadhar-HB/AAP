- name: Initialize vm_ips dictionary
  ansible.builtin.set_fact:
    vm_ips: {}

- name: Fetch IP address from the VLAN having gateway
  ansible.builtin.set_fact:
    ip_with_gw: "{{ item.ipaddress.split('/')[0] }}"
  loop: "{{ item.networkInterface }}"
  when: item.gw is defined and item.gw != ''

- name: Display extracted IP address
  ansible.builtin.debug:
    msg: "{{ ip_with_gw }}"

- name: Build vm_ips dictionary from IP results
  ansible.builtin.set_fact:
    vm_ips: "{{ vm_ips | combine({ vm_name: ip_with_gw }) }}"

- name: Wait for SSH (port 22) on all VM primary IPs
  ansible.builtin.wait_for:
    host: "{{ item.value }}"
    port: 22
    timeout: 300
    state: started
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value }})"

# -----------------------------------------
# REMOVE OLD SSH KEY USING ANSIBLE MODULE
# -----------------------------------------

- name: Remove old SSH key for VM from known_hosts
  ansible.builtin.known_hosts:
    name: "{{ item.value }}"
    state: absent
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value }})"

- name: Add new SSH key using Ansible module
  ansible.builtin.known_hosts:
    name: "{{ item.value }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -H ' ~ item.value) }}"
    state: present
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value }})"

# -----------------------------------------
# FIND LOG FILES USING ANSIBLE FIND MODULE
# -----------------------------------------

- name: Find log files on each VM
  ansible.builtin.find:
    paths: /root/logs/vm_config_thin_vol.sh/
    recurse: yes
    patterns: "script*"
    file_type: file
  delegate_to: "{{ item.value }}"
  register: found_scripts
  ignore_errors: true
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.key not in (failed_vms | default([]))

# -----------------------------------------
# READ FILES USING SLURP + CHECK FOR ERROR
# -----------------------------------------

- name: Read logs and search for ERROR
  ansible.builtin.slurp:
    src: "{{ item.1.files[0].path }}"
  delegate_to: "{{ item.0.value }}"
  register: vm_log_slurp
  loop: "{{ vm_ips | dict2items | zip(found_scripts.results) | list }}"
  loop_control:
    label: "{{ item.0.key }}"
  when:
    - item.1.files is defined
    - item.1.files | length > 0

- name: Fail if log contains ERROR
  ansible.builtin.fail:
    msg: |
      Found ERROR in logs on {{ item.0.key }} ({{ item.0.value }}):
      {{ (item.1.content | b64decode).split('\n') }}
  when:
    - (item.1.content | b64decode is search('ERROR'))
  loop: "{{ vm_ips | dict2items | zip(vm_log_slurp.results) | list }}"
  loop_control:
    label: "{{ item.0.key }}"

# -----------------------------------------
# COSIGN BLOCK (UNCHANGED EXCEPT SHELL REMOVED)
# -----------------------------------------

- block:
    - name: Import cosign_upg.yml
      ansible.builtin.import_tasks: cosign_upg.yml
      delegate_to: "{{ ip_with_gw }}"
      become: yes

    - name: Copy cosign_failed_vms to VMs
      ansible.builtin.copy:
        src: "{{ cosign_failed_vms }}"
        dest: "/DGdata/Software/{{ cosign_failed_vms | basename }}"
        mode: '0644'
      delegate_to: "{{ ip_with_gw }}"
      become: yes
  when: repo_url is defined and repo_url and cosign_pub_key_file is defined and cosign_pub_key_file

# -----------------------------------------
# NOT APPLYING COSIGN
# -----------------------------------------

- name: Not applying cosign when repo_url or key not defined
  ansible.builtin.debug:
    msg: "Skipping cosign verification as repo_url or cosign_pub_key_file not defined"
  when: repo_url is not defined or not repo_url or cosign_pub_key_file is not defined or not cosign_pub_key_file

# -----------------------------------------
# NSSWITCH + RESOLV.CONF FIX (NATIVE)
# -----------------------------------------

- name: Ensure dns is appended to hosts line in /etc/nsswitch.conf
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^hosts:'
    line: "hosts:      files myhostname dns"
  delegate_to: "{{ ip_with_gw }}"
  become: yes

- name: Ensure nameserver entry exists in resolv.conf
  ansible.builtin.lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
  delegate_to: "{{ ip_with_gw }}"
  become: yes