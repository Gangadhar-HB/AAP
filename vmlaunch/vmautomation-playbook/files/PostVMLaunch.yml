---
- name: Setting fact for vm hostname
  ansible.builtin.set_fact:
    ansible_host: "{{ inventory_hostname }}"

- name: Wait for SSH access on VM
  ansible.builtin.wait_for:
    host: "{{ vm_ip }}"
    port: 22
    timeout: 300

- name: Add VM to known_hosts
  ansible.builtin.shell: ls -lrt
  register: output

- debug:
    var: output

- name: Find log files on each VM
  ansible.builtin.find:
    paths: /root/logs/vm_config_thin_vol.sh/
    patterns: "script*"
    recurse: yes
  register: found_scripts

- name: Read log file on this VM
  ansible.builtin.slurp:
    src: "{{ found_scripts.files[0].path }}"
  register: slurped_log
  when: found_scripts.files | length > 0
  ignore_errors: true

- name: Fail if log contains ERROR
  ansible.builtin.fail:
    msg: |
      Found ERROR(s) in logs on {{ inventory_hostname }}:
      {{ slurped_log.content | b64decode }}
  when:
    - slurped_log.content is defined
    - (slurped_log.content | b64decode) is search('ERROR')


- block:
    - name: Import cosign_upg.yml
      ansible.builtin.import_tasks: cosign_upg.yml
      become: yes

    - name: Copy cosign_failed_vms to VMs
      ansible.builtin.copy:
        src: "{{ cosign_failed_vms }}"
        dest: "/DGdata/Software/{{ cosign_failed_vms | basename }}"
        mode: '0644'
      become: yes
  when:
    - repo_url is defined
    - repo_url
    - cosign_pub_key_file is defined
    - cosign_pub_key_file


- name: Not applying cosign when repo_url or key not defined
  ansible.builtin.debug:
    msg: "Skipping cosign verification as repo_url or cosign_pub_key_file not defined"
  when:
    - repo_url is not defined or not repo_url or cosign_pub_key_file is not defined or not cosign_pub_key_file

- name: Ensure dns is appended to hosts line in /etc/nsswitch.conf
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^hosts:'
    line: "hosts:      files myhostname dns"
  become: yes

- name: Ensure nameserver entry exists in resolv.conf
  ansible.builtin.lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
  become: yes