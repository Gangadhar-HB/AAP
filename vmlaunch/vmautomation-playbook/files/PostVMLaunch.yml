##########################################################################
# 1. Initialize dictionary
##########################################################################
- name: Initialize vm_ips dictionary
  set_fact:
    vm_ips: {}

##########################################################################
# 2. Extract Primary IP (the one with gateway)
##########################################################################
- name: Extract primary IP for this VM
  set_fact:
    ip_with_gw: "{{ item.ipaddress.split('/')[0] }}"
  loop: "{{ item.networkInterface }}"
  when: item.gw is defined and item.gw != ''

- name: Display primary IP
  debug:
    msg: "{{ ip_with_gw }}"

##########################################################################
# 3. Build vm_ips dictionary
##########################################################################
- name: Build vm_ips dictionary
  set_fact:
    vm_ips: "{{ vm_ips | combine({ item.name: ip_with_gw }) }}"

##########################################################################
# 4. Wait for SSH availability
##########################################################################
- name: Wait for SSH (22) availability
  ansible.builtin.wait_for:
    host: "{{ item.value }}"
    port: 22
    delay: 5
    timeout: 300
    state: started
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value }})"

##########################################################################
# 5. Manage known_hosts
##########################################################################
- name: Remove existing key from known_hosts
  ansible.builtin.known_hosts:
    name: "{{ item.value }}"
    state: absent
  delegate_to: localhost
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value }})"

- name: Add new SSH key for VM to known_hosts
  ansible.builtin.known_hosts:
    name: "{{ item.value }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -H ' ~ item.value) }}"
    state: present
  delegate_to: localhost
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value }})"

##########################################################################
# 6. Check for script files
##########################################################################
- name: Find script files on VM
  ansible.builtin.find:
    paths: "/root/logs/vm_config_thin_vol.sh/"
    patterns: "script*"
    file_type: file
  register: found_scripts
  delegate_to: "{{ item.value }}"
  when: item.key not in (failed_vms | default([]))
  loop: "{{ vm_ips | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value }})"

##########################################################################
# 7. Check Logs for Errors
##########################################################################
- name: Read log content for ERROR lines
  ansible.builtin.slurp:
    src: "{{ item.1.files | map(attribute='path') | list | first }}"
  register: log_scan_result
  delegate_to: "{{ item.0.value }}"
  when:
    - item.1.files is defined
    - item.1.files | length > 0
  loop: "{{ vm_ips | dict2items | zip(found_scripts.results) | list }}"
  loop_control:
    label: "{{ item.0.key }}"

- name: Fail if logs contain ERROR
  fail:
    msg: |
      Found ERROR(s) in logs on {{ vm_item.0.key }} ({{ vm_item.0.value }}):
      {{ log_scan_result.results[vm_item.1].stdout }}
  loop: "{{ vm_ips | dict2items | enumerate }}"
  loop_control:
    loop_var: vm_item
    index_var: vm_index
  when: "'ERROR' in (log_scan_result.results[vm_index].stdout | default(''))"

##########################################################################
# 8. Run cosign upgrade tasks per VM
##########################################################################
- block:
    - name: Import tasks â€“ cosign upgrade
      import_tasks: cosign_upg.yml
      delegate_to: "{{ ip_with_gw }}"
      become: yes

    - name: Copy failed list to VM
      ansible.builtin.copy:
        src: "{{ cosign_failed_vms }}"
        dest: "/DGdata/Software/{{ cosign_failed_vms | basename }}"
        mode: "0644"
      delegate_to: "{{ ip_with_gw }}"
      become: yes

  when:
    - repo_url is defined and repo_url is not none
    - cosign_pub_key_file is defined and cosign_pub_key_file is not none

##########################################################################
# 9. Skip cosign when not configured
##########################################################################
- name: Skipping cosign if not configured
  ansible.builtin.debug:
    msg: "Skipping cosign verification because repo_url or cosign_pub_key_file is not defined"
  when:
    - repo_url is not defined or repo_url is none
    - cosign_pub_key_file is not defined or cosign_pub_key_file is none

##########################################################################
# 10. Modify nsswitch.conf native
##########################################################################
- name: Ensure 'dns' exists in hosts line
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^hosts:'
    line: "hosts: files myhostname dns"
  delegate_to: "{{ ip_with_gw }}"
  become: yes

##########################################################################
# 11. Ensure resolv.conf has Google DNS
##########################################################################
- name: Ensure nameserver 8.8.8.8 exists
  ansible.builtin.lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
  delegate_to: "{{ ip_with_gw }}"
  become: yes
